const http=require("http"),express=require("express"),cors=require("cors"),path=require("path"),fs=require("fs"),{Server:WebSocketServer}=require("ws"),chokidar=require("chokidar"),net=require("net");let BASE_DIR=null,jsonData={},erudaEnabled=!1,consoleType="suger",zoomEnabled=!1,fileWatcher=null,connectedSockets=[];const defaultPort=1024,args=process.argv.slice(2);let currentPort=args[0]?parseInt(args[0]):1024;function isPortAvailable(e){return new Promise((r=>{const t=net.createServer().once("error",(()=>r(!1))).once("listening",(()=>t.close((()=>r(!0))))).listen(e)}))}const sugerScript='<script src="dt/suger-dev_1.0.0v.js"><\/script>',erudaRealScript="\n<script src=\"/eruda.min.js\"><\/script>\n<script>\n    if(typeof eruda !== 'undefined') eruda.init();\n<\/script>\n",inspectorScript='<script src="/inspector.js"><\/script>',zoomScript='\n<script src="/zoom-handler.js"><\/script>\n<script>try { new ZoomHandler(document.body); } catch (e) {}<\/script>',webSocketScript="\n<script>\n  (function() {\n    const wsUrl = 'ws://' + window.location.host;\n    const ws = new WebSocket(wsUrl);\n    ws.onmessage = (event) => { if (event.data === 'reload') window.location.reload(); };\n  })();\n<\/script>",app=express();app.use(cors()),app.use(express.json()),app.get("/check",((e,r)=>{r.status(200).json({message:"Ready",key:"AcodeLiveServer_NodeJS",port:currentPort})})),app.patch("/setup",((e,r)=>{const t=e.body;if(!t.fileName||!t.path)return r.status(400).json({error:"Missing fields"});BASE_DIR=t.path,jsonData=t,erudaEnabled=!0===t.eruda,t.consoleType&&(consoleType=t.consoleType),zoomEnabled=!0===t.zoom,console.log(`Base set to: ${BASE_DIR}`),startFileWatcher(r)})),app.get("/devtool-sw.js",((e,r)=>{const t=path.join(__dirname,"devtool-sw.js");fs.existsSync(t)?(r.setHeader("Content-Type","application/javascript"),r.setHeader("Service-Worker-Allowed","/"),r.sendFile(t)):r.status(404).send("SW not found")})),app.get("dt/suger-dev_1.0.0v.js",((e,r)=>r.sendFile(path.join(__dirname,"suger-dev_1.0.0v.js")))),app.get("/zoom-handler.js",((e,r)=>r.sendFile(path.join(__dirname,"zoom-handler.js")))),app.get("/inspector.js",((e,r)=>r.sendFile(path.join(__dirname,"inspector.js")))),app.get("/eruda.min.js",((e,r)=>{const t=path.join(__dirname,"eruda.min.js");fs.existsSync(t)?r.sendFile(t):r.status(404).send("Eruda not found on server")})),app.use(express.static(__dirname)),app.get("/",((e,r)=>{if(!BASE_DIR||!jsonData.fileName)return r.status(400).send("Not configured.");const t=path.join(BASE_DIR,jsonData.fileName);fs.readFile(t,"utf8",((e,t)=>{if(e)return r.status(500).send("Error reading file");let s=t;s=s.replace(/(<\/body>)/i,webSocketScript+"$1"),erudaEnabled&&(s="eruda"===consoleType?s.replace(/(<\/body>)/i,erudaRealScript+"\n"+inspectorScript+"$1"):s.replace(/(<\/body>)/i,sugerScript+"\n"+inspectorScript+"$1")),zoomEnabled&&(s=s.replace(/(<\/body>)/i,zoomScript+"$1")),r.send(s)}))})),app.use(((e,r,t)=>{BASE_DIR?express.static(BASE_DIR)(e,r,t):t()}));const server=http.createServer(app),wss=new WebSocketServer({server:server});function broadcastReload(){for(const e of connectedSockets)e.send("reload")}function startFileWatcher(e){if(fileWatcher&&fileWatcher.close(),BASE_DIR){fileWatcher=chokidar.watch(BASE_DIR,{ignored:/(^|[\/\\])\../,persistent:!0,ignoreInitial:!0}),fileWatcher.on("change",(()=>broadcastReload()));let r=!1;fileWatcher.on("ready",(()=>{r||(r=!0,e&&e.status(201).json({message:"OK"}))})),fileWatcher.on("error",(t=>{console.error("Watcher Error:",t.message),r||(r=!0,e&&e.status(500).json({error:t.message}))}))}}async function startServer(){await isPortAvailable(currentPort)||(console.error(`❌ Port ${currentPort} busy!`),process.exit(1)),server.listen(currentPort,"0.0.0.0",(()=>{console.log(`✅ Server running: http://localhost:${currentPort}`)}))}wss.on("connection",(e=>{connectedSockets.push(e),e.on("close",(()=>connectedSockets=connectedSockets.filter((r=>r!==e))))})),startServer();
