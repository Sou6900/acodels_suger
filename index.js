const http=require("http"),express=require("express"),cors=require("cors"),path=require("path"),fs=require("fs"),{Server:WebSocketServer}=require("ws"),chokidar=require("chokidar"),net=require("net");let BASE_DIR=null,jsonData={},erudaEnabled=!1,zoomEnabled=!1,fileWatcher=null,connectedSockets=[];const defaultPort=1024,args=process.argv.slice(2);let currentPort=args[0]?parseInt(args[0]):1024;function isPortAvailable(e){return new Promise((r=>{const o=net.createServer().once("error",(()=>r(!1))).once("listening",(()=>o.close((()=>r(!0))))).listen(e)}))}const erudaScript='<script src="dt/suger-dev_1.0.0v.js"><\/script>',inspectorScript='<script src="/inspector.js"><\/script>',zoomScript='\n<script src="/zoom-handler.js"><\/script>\n<script>\n    try { new ZoomHandler(document.body); } catch (e) { console.error(e); }\n<\/script>',webSocketScript="\n<script>\n  (function() {\n    const wsUrl = 'ws://' + window.location.host;\n    const ws = new WebSocket(wsUrl);\n    ws.onmessage = (event) => { \n        if (event.data === 'reload') {\n            console.log('Reloading page...');\n            window.location.reload(); \n        }\n    };\n  })();\n<\/script>",app=express();app.use(cors()),app.use(express.json()),app.get("/check",((e,r)=>{r.status(200).json({message:"Ready",key:"AcodeLiveServer_NodeJS",port:currentPort})})),app.patch("/setup",((e,r)=>{const o=e.body;if(!o.fileName||!o.path)return r.status(400).json({error:"Missing fileName or path"});BASE_DIR=o.path,jsonData=o,erudaEnabled=!0===o.eruda,zoomEnabled=!0===o.zoom,console.log(`Base directory set to: ${BASE_DIR}`),startFileWatcher(r)})),app.get("/devtool-sw.js",((e,r)=>{const o=path.join(__dirname,"devtool-sw.js");fs.existsSync(o)?(r.setHeader("Content-Type","application/javascript"),r.setHeader("Service-Worker-Allowed","/"),r.sendFile(o)):(console.error("âŒ devtool-sw.js not found in server directory!"),r.status(404).send("DevTool SW not found on server"))})),app.get("dt/suger-dev_1.0.0v.js",((e,r)=>{r.sendFile(path.join(__dirname,"suger-dev_1.0.0v.js"))})),app.get("/zoom-handler.js",((e,r)=>{r.sendFile(path.join(__dirname,"zoom-handler.js"))})),app.get("/inspector.js",((e,r)=>{r.sendFile(path.join(__dirname,"inspector.js"))})),app.use(express.static(__dirname)),app.get("/",((e,r)=>{if(!BASE_DIR||!jsonData.fileName)return r.status(400).send("Server not configured via plugin yet.");const o=path.join(BASE_DIR,jsonData.fileName);fs.readFile(o,"utf8",((e,o)=>{if(e)return console.error(`Error reading file: ${e}`),r.status(500).send("Error reading HTML file");let t=o;t=t.replace(/(<\/body>)/i,webSocketScript+"$1"),erudaEnabled&&(t=t.replace(/(<\/body>)/i,erudaScript+"\n"+inspectorScript+"$1")),zoomEnabled&&(t=t.replace(/(<\/body>)/i,zoomScript+"$1")),r.send(t)}))})),app.use(((e,r,o)=>{BASE_DIR?express.static(BASE_DIR)(e,r,o):o()}));const server=http.createServer(app),wss=new WebSocketServer({server});function broadcastReload(){console.log("File changed. Reloading clients...");for(const e of connectedSockets)e.send("reload")}function startFileWatcher(e){fileWatcher&&fileWatcher.close(),BASE_DIR&&(fileWatcher=chokidar.watch(BASE_DIR,{ignored:/(^|[\/\\])\../,persistent:!0,ignoreInitial:!0}),fileWatcher.on("change",(()=>broadcastReload())),fileWatcher.on("ready",(()=>{e&&e.status(201).json({message:"OK"})})),fileWatcher.on("error",(r=>{console.error("Watcher Error:",r),e&&e.status(500).json({error:r.message})})))}async function startServer(){await isPortAvailable(currentPort)||(console.error(`âŒ Error: Port ${currentPort} is busy!`),process.exit(1)),server.listen(currentPort,"0.0.0.0",(()=>{console.log(`âœ… Server running on: http://localhost:${currentPort}`),console.log("ðŸ“‚ Serving DevTool SW from virtual root.")}))}wss.on("connection",(e=>{connectedSockets.push(e),e.on("close",(()=>{connectedSockets=connectedSockets.filter((r=>r!==e))}))})),startServer();
